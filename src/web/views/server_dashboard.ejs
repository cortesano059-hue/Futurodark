<%- include('partials/header') %>

<div class="app-container">
    <aside class="servers-sidebar">
        <a href="/dashboard" class="srv-icon"><i class="fas fa-home"></i></a>
        <% mutualGuilds.forEach(g => { %>
            <a href="/dashboard/<%= g.id %>" class="srv-icon <%= g.id === guild.id ? 'active' : '' %>" style="background-image: url('<%= g.icon %>'); background-size: cover;">
                <% if(!g.icon) { %><%= g.acronym %><% } %>
            </a>
        <% }) %>
    </aside>

    <aside class="options-sidebar">
        <div style="padding:20px; font-weight:bold; border-bottom:1px solid #2f3136;"><%= guild.name %></div>
        <a href="#" class="menu-item active" data-tab="profile"><i class="fas fa-chart-pie"></i> Mi Perfil</a>
        <a href="#" class="menu-item" data-tab="shop"><i class="fas fa-store"></i> Tienda</a>
        <a href="#" class="menu-item" data-tab="inventory"><i class="fas fa-briefcase"></i> Inventario</a>
        <% if(isAdmin) { %>
            <a href="#" class="menu-item" data-tab="settings"><i class="fas fa-cog"></i> Ajustes del Bot</a>
        <% } %>
        
        <div style="margin-top: auto; padding-bottom: 20px;">
            <a href="/logout" class="menu-item" style="color:#ed4245;"><i class="fas fa-power-off"></i> Cerrar Sesi贸n</a>
        </div>
    </aside>

    <main class="content-area">
        
        <div id="section-profile" class="dashboard-section">
            <div class="card">
                <h2>Resumen de Cuenta</h2>
                <div class="economy-box" style="margin: 20px 0;">
                    <div class="eco-item">
                        <span class="eco-label">Cartera</span>
                        <span class="eco-val wallet">$<%= economy.money.toLocaleString() %></span>
                    </div>
                    <div class="divider-vertical"></div>
                    <div class="eco-item">
                        <span class="eco-label">Banco</span>
                        <span class="eco-val bank">$<%= economy.bank.toLocaleString() %></span>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-shop" class="dashboard-section" style="display:none;">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h3 style="margin:0;">Tienda de <%= guild.name %></h3>
                    <% if(isAdmin) { %>
                        <button class="btn btn-primary" onclick="toggleShopForm('create')">+ Crear Nuevo tem</button>
                    <% } %>
                </div>

                <div id="shop-admin-form" style="display:none; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; border: 1px solid var(--accent); margin-bottom: 25px;">
                    <h4 id="form-title" style="margin-top:0;">Configurar tem</h4>
                    <input type="hidden" id="f-id">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div>
                            <label class="eco-label">Nombre del tem</label>
                            <input type="text" id="f-name" class="eco-input" placeholder="Ej: Espada Legendaria">
                        </div>
                        <div>
                            <label class="eco-label">Precio</label>
                            <input type="number" id="f-price" class="eco-input" placeholder="1000">
                        </div>
                        <div>
                            <label class="eco-label">Emoji</label>
                            <input type="text" id="f-emoji" class="eco-input" placeholder="锔">
                        </div>
                        <div>
                            <label class="eco-label">Descripci贸n</label>
                            <input type="text" id="f-desc" class="eco-input" placeholder="Breve descripci贸n...">
                        </div>
                    </div>
                    <div style="margin-top: 15px; display:flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="submitItem()">Guardar Cambios</button>
                        <button class="btn btn-secondary" onclick="toggleShopForm()">Cancelar</button>
                    </div>
                </div>

                <div class="shop-grid">
                    <% items.forEach(item => { %>
                        <div class="shop-card">
                            <div style="font-size: 32px;"><%= item.emoji || '' %></div>
                            <div class="shop-body">
                                <div class="shop-title"><%= item.itemName %></div>
                                <div class="shop-desc"><%= item.description %></div>
                            </div>
                            <div class="shop-footer">
                                <div class="price">$<%= item.price.toLocaleString() %></div>
                                <div style="display:flex; gap:5px;">
                                    <button class="btn btn-primary" style="padding: 8px 15px;" onclick="buyItem('<%= item._id %>')">Comprar</button>
                                    <% if(isAdmin) { %>
                                        <button class="btn btn-secondary" style="padding: 8px 10px;" onclick="editItem('<%= JSON.stringify(item) %>')"><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-secondary" style="padding: 8px 10px; color: #ff4757;" onclick="deleteItem('<%= item._id %>')"><i class="fas fa-trash"></i></button>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>

        <div id="section-inventory" class="dashboard-section" style="display:none;">
            <div class="card">
                <h3>Tu Inventario Personal</h3>
                <div class="inventory-grid">
                    <% if(inventory.length > 0) { %>
                        <% inventory.forEach(it => { %>
                            <div class="inv-card">
                                <div style="font-size: 28px;"><%= it.emoji %></div>
                                <div class="inv-name"><%= it.name %></div>
                                <div class="inv-count">Cantidad: <%= it.amount %></div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <p style="color: var(--text-dim); text-align: center; width: 100%;">No tienes objetos en tu mochila todav铆a.</p>
                    <% } %>
                </div>
            </div>
        </div>

    </main>
</div>

<script>
    // Sistema de navegaci贸n limpia (evita solapamientos)
    document.querySelectorAll('.menu-item[data-tab]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const target = btn.getAttribute('data-tab');

            // 1. Botones activos
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            btn.classList.add('active');

            // 2. Ocultar todas las secciones
            document.querySelectorAll('.dashboard-section').forEach(sec => sec.style.display = 'none');

            // 3. Mostrar la elegida
            document.getElementById(`section-${target}`).style.display = 'block';
        });
    });

    const guildId = '<%= guild.id %>';

    // L贸gica Tienda: Gesti贸n
    function toggleShopForm(mode) {
        const form = document.getElementById('shop-admin-form');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
        if(mode === 'create') {
            document.getElementById('f-id').value = '';
            document.getElementById('f-name').value = '';
            document.getElementById('f-price').value = '';
            document.getElementById('f-emoji').value = '';
            document.getElementById('f-desc').value = '';
            document.getElementById('form-title').innerText = 'Crear Nuevo tem';
        }
    }

    function editItem(json) {
        const item = JSON.parse(json);
        toggleShopForm();
        document.getElementById('form-title').innerText = 'Editando: ' + item.itemName;
        document.getElementById('f-id').value = item._id;
        document.getElementById('f-name').value = item.itemName;
        document.getElementById('f-price').value = item.price;
        document.getElementById('f-emoji').value = item.emoji;
        document.getElementById('f-desc').value = item.description;
    }

    async function submitItem() {
        const id = document.getElementById('f-id').value;
        const payload = {
            action: id ? 'edit' : 'create',
            id: id,
            itemName: document.getElementById('f-name').value,
            price: document.getElementById('f-price').value,
            emoji: document.getElementById('f-emoji').value,
            description: document.getElementById('f-desc').value,
            type: 'normal'
        };

        const res = await fetch(`/api/guilds/${guildId}/items/manage`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if((await res.json()).ok) location.reload();
    }

    async function deleteItem(id) {
        if(!confirm('驴Est谩s seguro de que quieres eliminar este 铆tem?')) return;
        const res = await fetch(`/api/guilds/${guildId}/items/manage`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ action: 'delete', id: id })
        });
        if((await res.json()).ok) location.reload();
    }

    // L贸gica Tienda: Compra
    async function buyItem(itemId) {
        const res = await fetch(`/api/guilds/${guildId}/tienda/buy`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ itemId })
        });
        const data = await res.json();
        if(data.ok) {
            alert('隆Compra realizada con 茅xito! Nuevo saldo: $' + data.newBalance);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'No se pudo completar la compra'));
        }
    }
</script>

<%- include('partials/footer') %>